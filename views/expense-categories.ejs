<% layout('layout') -%>

<div class="page-header d-flex justify-content-between align-items-center">
  <div>
    <h3><i class="bi bi-tags"></i> Manage Expense Categories</h3>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/expenses">Expenses</a></li>
        <li class="breadcrumb-item active">Categories</li>
      </ol>
    </nav>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
    <i class="bi bi-plus-circle"></i> Add Category
  </button>
</div>

<div class="card">
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th>Category Name</th>
          <th class="text-center">Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (categories.length === 0) { %>
          <tr><td colspan="3" class="text-center text-muted py-4">No expense categories found. Add one to get started.</td></tr>
        <% } else { %>
          <% categories.forEach(cat => { %>
            <tr data-id="<%= cat.id %>">
              <td>
                <span class="category-name"><%= cat.name %></span>
                <input type="text" class="form-control d-none edit-name" value="<%= cat.name %>" style="max-width: 250px;">
              </td>
              <td class="text-center">
                <% if (cat.is_active) { %>
                  <span class="badge bg-success">Active</span>
                <% } else { %>
                  <span class="badge bg-secondary">Disabled</span>
                <% } %>
              </td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary btn-edit" onclick="startEdit(this)" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-success btn-save d-none" onclick="saveEdit(<%= cat.id %>, this)" title="Save">
                  <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary btn-cancel d-none" onclick="cancelEdit(this)" title="Cancel">
                  <i class="bi bi-x-lg"></i>
                </button>
                <% if (cat.is_active) { %>
                  <button class="btn btn-sm btn-outline-warning" onclick="toggleStatus(<%= cat.id %>, false)" title="Disable">
                    <i class="bi bi-pause-circle"></i>
                  </button>
                <% } else { %>
                  <button class="btn btn-sm btn-outline-success" onclick="toggleStatus(<%= cat.id %>, true)" title="Enable">
                    <i class="bi bi-play-circle"></i>
                  </button>
                <% } %>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(<%= cat.id %>, '<%= cat.name %>')" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<div class="mt-3">
  <a href="/expenses" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Expenses</a>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Category Name *</label>
        <input type="text" id="newCategoryName" class="form-control" placeholder="e.g., Equipment">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="addCategory()">Add</button>
      </div>
    </div>
  </div>
</div>

<script>
async function addCategory() {
  const name = document.getElementById('newCategoryName').value.trim();
  if (!name) { alert('Please enter a category name'); return; }
  
  const res = await fetch('/expenses/categories', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  });
  const data = await res.json();
  if (res.ok) {
    location.reload();
  } else {
    alert(data.error || 'Failed to add category');
  }
}

function startEdit(btn) {
  const row = btn.closest('tr');
  row.querySelector('.category-name').classList.add('d-none');
  row.querySelector('.edit-name').classList.remove('d-none');
  row.querySelector('.btn-edit').classList.add('d-none');
  row.querySelector('.btn-save').classList.remove('d-none');
  row.querySelector('.btn-cancel').classList.remove('d-none');
  row.querySelector('.edit-name').focus();
}

function cancelEdit(btn) {
  const row = btn.closest('tr');
  row.querySelector('.category-name').classList.remove('d-none');
  row.querySelector('.edit-name').classList.add('d-none');
  row.querySelector('.btn-edit').classList.remove('d-none');
  row.querySelector('.btn-save').classList.add('d-none');
  row.querySelector('.btn-cancel').classList.add('d-none');
}

async function saveEdit(id, btn) {
  const row = btn.closest('tr');
  const newName = row.querySelector('.edit-name').value.trim();
  if (!newName) { alert('Category name cannot be empty'); return; }
  
  const res = await fetch('/expenses/categories/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: newName })
  });
  const data = await res.json();
  if (res.ok) {
    location.reload();
  } else {
    alert(data.error || 'Failed to update category');
  }
}

async function toggleStatus(id, active) {
  const res = await fetch('/expenses/categories/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_active: active })
  });
  if (res.ok) {
    location.reload();
  } else {
    const data = await res.json();
    alert(data.error || 'Failed to update status');
  }
}

async function deleteCategory(id, name) {
  if (!confirm('Delete category "' + name + '"?\n\nIf this category has expenses, it will be disabled instead.')) return;
  
  const res = await fetch('/expenses/categories/' + id, { method: 'DELETE' });
  const data = await res.json();
  if (res.ok) {
    location.reload();
  } else {
    alert(data.error || 'Failed to delete category');
  }
}
</script>
